# Bilibili LRC 字幕弹幕发送工具

这是一个功能强大的 TypeScript 脚本，可以将本地的 LRC 歌词文件，以底部弹幕的形式，精准地发送到指定的 Bilibili 视频中。

它足够智能，可以避免重复发送、更新现有字幕颜色，甚至能检测 B 站的风控系统（Shadowban），确保每一条字幕都对所有观众可见。

## ✨ 主要功能

- **LRC 转弹幕**: 自动解析 LRC 文件，将带有时间轴的歌词转换为视频弹幕。
- **自动登录**: 程序启动时通过二维码扫码登录，并自动保存 Cookie 用于后续免登录操作。
- **WBI 鉴权**: 内置了 B 站最新的 WBI 签名算法，确保所有 API 请求都能成功鉴权。
- **智能同步**:
  - **精准比对**: 在发送前，会检查视频中已有的弹幕，只有内容、时间点和颜色都**不匹配**的字幕才会被发送。
  - **避免重复**: 多次运行不会重复发送已存在的字幕。
  - **颜色更新**: 如果您只在配置文件中修改了颜色，程序会自动用新颜色重新发送所有字幕。
- **风控检测 (Shadowban)**:
  - **自我修正**: 在发送前，以**游客视角**检查弹幕，能发现并重新发送之前被“影子禁言”（仅自己可见）的弹幕。
  - **双重校验**: 发送完成后，同时使用**登录用户**和**游客**两种身份进行检查，精准判断每条字幕的最终状态。
- **高度可配置**:
  - 可自定义目标视频（BV号）、LRC 文件路径。
  - 可自定义弹幕发送的速率，有效避免因过快操作被风控。
  - 可自定义弹幕的**颜色**。
- **详细报告**: 任务结束后，会在控制台生成一份清晰的报告，明确告知哪些字幕“成功发送”、“被风控”或“发送失败”。

## 📦 环境准备

在开始之前，请确保您的电脑上已安装以下软件：

- [Node.js](https://nodejs.org/) (建议版本 v16 或更高)
- npm (通常随 Node.js 一起安装)

## 🚀 安装与设置

1.  **克隆或下载项目**

    ```bash
    git clone https://github.com/your-username/bilibili-lrc-danmaku.git
    # 或者直接下载ZIP压缩包并解压
    ```

2.  **进入项目目录**

    ```bash
    cd bilibili-lrc-danmaku
    ```

3.  **安装依赖**

    ```bash
    npm install
    ```

## ⚙️ 配置文件说明

在运行程序之前，您需要创建并配置项目根目录下的 `config.json` 文件。如果该文件不存在，程序首次运行时会自动提示您创建。

**`config.json` 示例:**

```json
{
  "bvid": "BV1xx411c7mD",
  "lrcPath": "./lyrics.lrc",
  "sendInterval": 8000,
  "danmakuColor": "#FFFFFF"
}
```

- **`bvid` (必需)**:
  - 类型: `string`
  - 说明: 您要发送弹幕的目标视频的 BV 号。

- **`lrcPath` (必需)**:
  - 类型: `string`
  - 说明: 您的 LRC 歌词文件的路径。可以使用相对路径（如 `./lyrics.lrc`）或绝对路径。

- **`sendInterval` (可选)**:
  - 类型: `number`
  - 说明: 每条弹幕发送之间的间隔时间，单位为**毫秒**。为了避免被B站风控，建议设置在 `10000` (10秒) 到 `20000` (20秒) 之间。默认值为 `20000`。

- **`danmakuColor` (可选)**:
  - 类型: `string`
  - 说明: 弹幕的颜色，使用标准的十六进制颜色码（Hex）。默认值为 `"#FFFFFF"` (白色)。
  - 示例: `"#FF0000"` (红色), `"#00FF00"` (绿色), `"#FFD700"` (B站会员金)。

## ▶️ 如何运行

1.  **准备您的 LRC 文件**: 将您的 `.lrc` 文件放置到项目中，并确保 `config.json` 中的 `lrcPath` 路径正确。

2.  **修改配置**: 打开 `config.json` 文件，填入正确的 `bvid` 和您期望的配置。

3.  **启动程序**: 在项目根目录下，运行以下命令：

    ```bash
    npx ts-node src/main.ts
    ```

4.  **首次登录**:
    - 程序会在终端显示一个二维码。
    - 请使用您的 Bilibili 手机客户端扫描此二维码，并确认登录。
    - 登录成功后，程序会自动创建一个 `cookie.json` 文件，用于保存登录状态。

5.  **后续运行**:
    - 程序将自动使用 `cookie.json` 文件进行登录，无需再次扫码（除非 Cookie 过期）。
    - 程序会开始执行“检查 -> 发送 -> 校验”的智能流程。

6.  **查看结果**:
    - 在程序运行过程中，您可以实时看到每一步的日志。
    - 任务结束后，请仔细查看控制台输出的最终校验报告。

## 🔍 工作原理解析

本程序的工作流被精心设计为三个阶段，以确保最佳效果：

1.  **阶段一：预检查与比对**
    - 程序首先以**游客身份**获取视频的公开弹幕列表。
    - 然后，将本地 LRC 文件的每一行与公开弹幕进行**内容、时间、颜色**的三重比对。
    - 只有在公开弹幕池中不存在的字幕，才会被加入“待发送列表”。这个机制保证了程序的**自我修正**能力。

2.  **阶段二：发送**
    - 程序遍历“待发送列表”，按照您设定的 `sendInterval` 间隔，逐条发送弹幕。

3.  **阶段三：双重校验与报告**
    - 发送完成后，程序会等待片刻（让服务器数据同步）。
    - 接着，它会**同时**获取“登录用户视角”和“游客视角”的弹幕列表。
    - 通过比对这两个列表，程序能精准地判断出每条弹幕的最终状态（成功、被风控或失败），并生成最终报告。

## ⚠️ 疑难解答

- **WBI 签名失败 / API 报错**
  B 站可能会不定期更新 WBI 签名的 `mixinKey`。如果遇到持续的 API 错误，可能需要更新 `src/bilibili-api.ts` 文件中的 `MIXIN_KEY_ENC_TAB` 常量。

- **弹幕被大量 Shadowban**
  如果报告显示大量弹幕被风控，请尝试增加 `config.json` 中的 `sendInterval` 值（例如增加到 `15000`），或者更换账号、过一段时间再试。

- **登录失败或 Cookie 失效**
  如果程序提示登录失败或 Cookie 失效，请手动删除项目根目录下的 `cookie.json` 文件，然后重新运行程序，即可触发新的二维码扫码登录流程。

## 📄 许可证

本项目采用 [MIT](./LICENSE) 许可证。